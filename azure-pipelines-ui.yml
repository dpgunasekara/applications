# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

resources:
 repositories:
   - repository: bobr3portal
     type: git
     name: 'BOB - Digital Revenue Collection System/bobr3portal'
   - repository: bobsignage
     type: git
     name: 'BOB - Digital Revenue Collection System/bobsignage'
   - repository: bobnovatrackintportal
     type: git
     name: 'BOB - Digital Revenue Collection System/bobnovatrackintportal'
   - repository: bobnovatrackextportal
     type: git
     name: 'BOB - Digital Revenue Collection System/bobnovatrackextportal'
   - repository: bobburssimulator
     type: git
     name: 'BOB - Digital Revenue Collection System/bobburssimulator'
   - repository: bobcicd
     type: git
     name: 'BOB - Digital Revenue Collection System/bobcicd'

variables:
  - name: dockerfilePath-1
    value: '$(Build.SourcesDirectory)/Dockerfile-1'
  - name: dockerfilePath-2
    value: '$(Build.SourcesDirectory)/Dockerfile-2'
  - name: tag
    value: '$(Build.BuildId)'
  - name: vmImageName
    value: 'ubuntu-latest'
  - name: environmentName
    value: 'uat' 
  - group: build-variables        

stages:
- stage: Build
  displayName: Build and push stage
  jobs:
  - job: Build_bobr3portal
    displayName: Build bobR3portal
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: bobR3portal
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: 'bobr3portal'
        dockerfile: $(dockerfilePath-1)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          latest
          $(Build.BuildId)
    - task: Docker@2
      displayName: Build and push an image to container registry 2
      inputs:
        command: buildAndPush
        repository: 'bobr3portal'
        dockerfile: $(dockerfilePath-2)
        containerRegistry: $(dockerRegistryServiceConnection2)
        tags: |
          latest
          $(Build.BuildId)

  - job: Build_bobsignage
    displayName: Build bobsignage
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: bobsignage
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: 'bobsignage'
        dockerfile: $(dockerfilePath-1)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          latest
          $(Build.BuildId)
    - task: Docker@2
      displayName: Build and push an image to container registry 2
      inputs:
        command: buildAndPush
        repository: 'bobsignage'
        dockerfile: $(dockerfilePath-2)
        containerRegistry: $(dockerRegistryServiceConnection2)
        tags: |
          latest
          $(Build.BuildId)

  - job: Build_bobnovatrackintportal
    displayName: Build bobnovatrackintportal
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: bobnovatrackintportal
    - script: |
        cp $(Build.SourcesDirectory)/.env.$(environmentName) $(Build.SourcesDirectory)/.env
      displayName: "Use environment-specific .env"    
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: 'bobnovatrackintportal'
        dockerfile: $(dockerfilePath-1)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          latest
          $(Build.BuildId)
    - task: Docker@2
      displayName: Build and push an image to container registry 2
      inputs:
        command: buildAndPush
        repository: 'bobnovatrackintportal'
        dockerfile: $(dockerfilePath-2)
        containerRegistry: $(dockerRegistryServiceConnection2)
        tags: |
          latest
          $(Build.BuildId)

  - job: Build_bobnovatrackextportal
    displayName: Build bobnovatrackextportal
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: bobnovatrackextportal
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: 'bobnovatrackextportal'
        dockerfile: $(dockerfilePath-1)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          latest
          $(Build.BuildId)  
    - task: Docker@2
      displayName: Build and push an image to container registry 2
      inputs:
        command: buildAndPush
        repository: 'bobnovatrackextportal'
        dockerfile: $(dockerfilePath-2)
        containerRegistry: $(dockerRegistryServiceConnection2)
        tags: |
          latest
          $(Build.BuildId)  

  - job: Build_bobburssimulator
    displayName: Build bobburssimulator
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: bobburssimulator
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: 'bobburssimulator'
        dockerfile: $(dockerfilePath-1)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          latest
          $(Build.BuildId)              
    - task: Docker@2
      displayName: Build and push an image to container registry 2
      inputs:
        command: buildAndPush
        repository: 'bobburssimulator'
        dockerfile: $(dockerfilePath-2)
        containerRegistry: $(dockerRegistryServiceConnection2)
        tags: |
          latest
          $(Build.BuildId)                        
- stage: Deploy
  displayName: Deploy to AKS
  jobs:
    - deployment: HelmDeploy
      displayName: Deploy using Helm
      environment: 'uat'
      pool:
        name: AKS-UAT-Pool-01
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: bobcicd

              - task: AzureCLI@2
                displayName: 'Login to AKS cluster'
                inputs:
                  azureSubscription: 'HelmDeployConnection'
                  scriptType: pscore
                  scriptLocation: inlineScript
                  inlineScript: |
                    echo "Getting AKS credentials"
                    az aks get-credentials --resource-group rg-aksc-nonprod-ldzn-cin-01 --name aks-uat-01 --overwrite-existing
              - script: |
                 echo "Running helm upgrade..."
                 cd uat/helm/novusware-containers
                 helm upgrade svc-release . --namespace drcs-uat-01
                displayName: 'Helm Upgrade'