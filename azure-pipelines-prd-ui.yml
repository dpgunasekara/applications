# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

resources:
 repositories:
   - repository: bobr3portal
     type: git
     name: 'BOB - Digital Revenue Collection System/bobr3portal'
   - repository: bobsignage
     type: git
     name: 'BOB - Digital Revenue Collection System/bobsignage'
   - repository: bobnovatrackintportal
     type: git
     name: 'BOB - Digital Revenue Collection System/bobnovatrackintportal'
   - repository: bobnovatrackextportal
     type: git
     name: 'BOB - Digital Revenue Collection System/bobnovatrackextportal'
   - repository: bobcicd
     type: git
     name: 'BOB - Digital Revenue Collection System/bobcicd'

variables:
  - name: dockerfilePath-1
    value: '$(Build.SourcesDirectory)/Dockerfile-prd'
  - name: tag
    value: '$(Build.BuildId)'
  - name: vmImageName
    value: 'ubuntu-latest'
  - name: environmentName
    value: 'uat' 
  - group: build-variables        

stages:
- stage: Build
  displayName: Build and push stage
  jobs:
  - job: Build_bobr3portal
    displayName: Build bobR3portal
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: bobR3portal
    - task: Docker@2
      displayName: Build and push an image to container registry 3
      inputs:
        command: buildAndPush
        repository: 'bobr3portal'
        dockerfile: $(dockerfilePath-1)
        containerRegistry: $(dockerRegistryServiceConnection3)
        tags: |
          latest
          $(Build.BuildId)

  - job: Build_bobsignage
    displayName: Build bobsignage
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: bobsignage
    - task: Docker@2
      displayName: Build and push an image to container registry 3
      inputs:
        command: buildAndPush
        repository: 'bobsignage'
        dockerfile: $(dockerfilePath-1)
        containerRegistry: $(dockerRegistryServiceConnection3)
        tags: |
          latest
          $(Build.BuildId)

  - job: Build_bobnovatrackintportal
    displayName: Build bobnovatrackintportal
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: bobnovatrackintportal
    - task: Docker@2
      displayName: Build and push an image to container registry 3
      inputs:
        command: buildAndPush
        repository: 'bobnovatrackintportal'
        dockerfile: $(dockerfilePath-1)
        containerRegistry: $(dockerRegistryServiceConnection3)
        tags: |
          latest
          $(Build.BuildId)

  - job: Build_bobnovatrackextportal
    displayName: Build bobnovatrackextportal
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: bobnovatrackextportal
    - task: Docker@2
      displayName: Build and push an image to container registry 3
      inputs:
        command: buildAndPush
        repository: 'bobnovatrackextportal'
        dockerfile: $(dockerfilePath-1)
        containerRegistry: $(dockerRegistryServiceConnection3)
        tags: |
          latest
          $(Build.BuildId)  
